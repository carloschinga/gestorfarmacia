<style>
    .chart-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 columnas */
        gap: 20px; /* Espaciado entre gr치ficos */
        justify-content: center;
        align-items: start;
        text-align: center;
    }

    .chart-box {
        min-width: 300px;
        max-width: 500px;
        margin: auto;
    }

    /* 游댳 Asegurar que "Ventas por Sede" ocupe toda la segunda fila */
    .chart-box:nth-child(3) {
        grid-column: span 2;
    }

</style>
<div class="container mt-5">
    <h2 class="text-center">Dashboard de Ventas</h2>

    <div class="chart-container">
        <div class="chart-box">
            <h4>Ventas por Mes</h4>
            <canvas id="ventasPorMes"></canvas>
        </div>
        <div class="chart-box">
            <h4>Ventas por Producto</h4>
            <canvas id="ventasPorProducto"></canvas>
        </div>
        <div class="chart-box">
            <h4>Ventas por Sede</h4>
            <canvas id="ventasPorSede"></canvas>
        </div>
    </div>
</div>

<script>
    async function fetchVentasData() {
        try {
            const response = await fetch('ventasgraficosservlet');
            if (!response.ok)
                throw new Error(`HTTP error! Status: ${response.status}`);

            const data = await response.json();
            console.log("Datos recibidos del servlet:", data); // Debug

            if (!data || typeof data !== 'object')
                throw new Error("Los datos recibidos no son v치lidos");

            return data;
        } catch (error) {
            console.error("Error al obtener los datos", error);
            return null;
        }
    }

    let chartInstances = {}; // 游댳 Para almacenar referencias a los gr치ficos

    async function renderCharts() {
        const data = await fetchVentasData();
        if (!data)
            return;

        if (!data.ventasPorMes || !data.ventasPorProducto || !data.ventasPorSede) {
            console.error("El JSON no tiene los datos esperados:", data);
            return;
        }

        // 游댳 Obtener los 20 productos m치s vendidos correctamente
        const topProductos = Object.entries(data.ventasPorProducto)
                .sort((a, b) => b[1] - a[1]) // Ordenar de mayor a menor ventas
                .slice(0, 20); // Seleccionar los 20 primeros

        const topProductosLabels = topProductos.map(p => p[0]);
        const topProductosValues = topProductos.map(p => p[1]);

        // 游댳 Configurar gr치ficos
        const chartConfigs = [
            {
                id: "ventasPorMes",
                type: "bar",
                label: "Total Vendido",
                labels: Object.keys(data.ventasPorMes),
                values: Object.values(data.ventasPorMes),
                backgroundColor: "rgba(54, 162, 235, 0.5)",
                borderColor: "rgba(54, 162, 235, 1)"
            },
            {
                id: "ventasPorProducto",
                type: "bar",
                label: "Top 20 Productos M치s Vendidos",
                labels: topProductosLabels,
                values: topProductosValues,
                backgroundColor: Array.from({length: 20}, () => `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.5)`),
                options: {
                    scales: {
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45, // 游댳 Rotar etiquetas para que no se sobrepongan
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            },
            {
                id: "ventasPorSede",
                type: "doughnut",
                labels: Object.keys(data.ventasPorSede),
                values: Object.values(data.ventasPorSede),
                backgroundColor: ["#ff6384", "#36a2eb", "#ffce56"]
            }
        ];

        // 游댳 Generar gr치ficos din치micamente
        chartConfigs.forEach(config => {
            const canvas = document.getElementById(config.id);
            if (!canvas) {
                console.error(`No se encontr칩 el canvas con id: ${config.id}`);
                return;
            }

            // 游댳 Destruir el gr치fico previo si ya existe (para evitar errores)
            if (chartInstances[config.id]) {
                chartInstances[config.id].destroy();
            }

            chartInstances[config.id] = new Chart(canvas, {
                type: config.type,
                data: {
                    labels: config.labels,
                    datasets: [{
                            label: config.label || "",
                            data: config.values,
                            backgroundColor: config.backgroundColor,
                            borderColor: config.borderColor || null,
                            borderWidth: config.borderColor ? 1 : null
                        }]
                },
                options: {
                    responsive: true,
                    scales: config.scales || (config.type === "bar" ? {y: {beginAtZero: true}} : {})
                }
            });
        });
    }

// 游댳 Iniciar los gr치ficos
    renderCharts();

</script>
</html>
